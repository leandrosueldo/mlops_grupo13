# Comandos para ejecutar DIRECTAMENTE en EC2
# Copia y pega estos comandos en tu sesiÃ³n SSH de EC2

# Activar entorno
source ~/airflow-env/bin/activate
export AIRFLOW_HOME=~/airflow

# Detener procesos antiguos
echo "Deteniendo procesos antiguos..."
pkill -9 -f "airflow webserver" 2>/dev/null || true
pkill -9 -f "airflow scheduler" 2>/dev/null || true
pkill -9 -f "gunicorn.*airflow" 2>/dev/null || true
sleep 3

# Verificar que estÃ©n detenidos
REMAINING=$(ps aux | grep -E "(airflow|gunicorn)" | grep -v grep | wc -l)
if [ "$REMAINING" -gt 0 ]; then
    echo "Forzando detenciÃ³n..."
    pkill -9 -f airflow 2>/dev/null || true
    sleep 2
fi

echo "âœ… Procesos detenidos"
echo ""

# Configurar variables
export AIRFLOW__CORE__LOAD_EXAMPLES=False
export AIRFLOW__CORE__DAGS_FOLDER=~/airflow/dags

# Verificar configuraciÃ³n
if [ ! -f $AIRFLOW_HOME/airflow.cfg ]; then
    echo "Inicializando Airflow..."
    airflow db init
fi

echo "Iniciando webserver..."
cd $AIRFLOW_HOME
nohup airflow webserver -p 8080 > /tmp/airflow_webserver.log 2>&1 &
WEBSERVER_PID=$!
echo "Webserver iniciado (PID: $WEBSERVER_PID)"
sleep 15

# Verificar webserver
if ps aux | grep -q "[g]unicorn.*airflow"; then
    echo "âœ… Webserver iniciado correctamente"
    ps aux | grep "[g]unicorn.*airflow" | grep -v grep | head -1
else
    echo "âŒ Error iniciando webserver"
    echo "Ãšltimas lÃ­neas del log:"
    tail -20 /tmp/airflow_webserver.log
    exit 1
fi

# Verificar puerto
echo ""
echo "Verificando puerto 8080..."
if ss -tlnp 2>/dev/null | grep -q ":8080"; then
    echo "âœ… Puerto 8080 estÃ¡ escuchando"
    ss -tlnp 2>/dev/null | grep 8080
elif netstat -tlnp 2>/dev/null | grep -q ":8080"; then
    echo "âœ… Puerto 8080 estÃ¡ escuchando"
    netstat -tlnp 2>/dev/null | grep 8080
else
    echo "âš ï¸  Puerto 8080 aÃºn no estÃ¡ escuchando (puede tardar unos segundos mÃ¡s)"
fi

echo ""
echo "Iniciando scheduler..."
nohup airflow scheduler > /tmp/airflow_scheduler.log 2>&1 &
SCHEDULER_PID=$!
echo "Scheduler iniciado (PID: $SCHEDULER_PID)"
sleep 10

# Verificar scheduler
if ps aux | grep -q "[a]irflow scheduler"; then
    echo "âœ… Scheduler iniciado correctamente"
    ps aux | grep "[a]irflow scheduler" | grep -v grep | head -1
else
    echo "âŒ Error iniciando scheduler"
    echo "Ãšltimas lÃ­neas del log:"
    tail -20 /tmp/airflow_scheduler.log
    exit 1
fi

echo ""
echo "=========================================="
echo "âœ… CONFIGURACIÃ“N COMPLETADA"
echo "=========================================="
echo ""
echo "Verificando estado final..."
ps aux | grep -E "(airflow|gunicorn)" | grep -v grep | head -5
echo ""
PUBLIC_IP=$(curl -s http://169.254.169.254/latest/meta-data/public-ipv4 2>/dev/null || echo "18.118.31.28")
echo "ğŸ“Œ Accede a: http://$PUBLIC_IP:8080"
echo "   Usuario: admin"
echo "   ContraseÃ±a: admin"
echo ""
echo "â³ Espera 20-30 segundos y luego abre el navegador"
echo ""


